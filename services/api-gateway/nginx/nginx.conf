worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    multi_accept on;
}

http {
    # ─── Basic settings ───────────────────────────────────────────────
    include       /etc/nginx/mime.types;
    default_type  application/json;       # Default to JSON for an API gateway

    # ─── Logging (JSON structured) ────────────────────────────────────
    log_format json_combined escape=json
        '{'
            '"time":"$time_iso8601",'
            '"remote_addr":"$remote_addr",'
            '"request":"$request",'
            '"status":$status,'
            '"body_bytes_sent":$body_bytes_sent,'
            '"request_time":$request_time,'
            '"upstream_response_time":"$upstream_response_time",'
            '"http_user_agent":"$http_user_agent",'
            '"http_x_forwarded_for":"$http_x_forwarded_for",'
            '"request_id":"$request_id",'
            '"upstream_addr":"$upstream_addr"'
        '}';

    access_log /var/log/nginx/access.log json_combined;

    # ─── Performance ──────────────────────────────────────────────────
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;
    keepalive_requests 1000;

    # ─── Security headers ─────────────────────────────────────────────
    server_tokens off;                     # Hide Nginx version
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Request-ID $request_id always;

    # ─── Buffer / body size ───────────────────────────────────────────
    client_max_body_size 10m;              # Increase when file uploads are needed
    client_body_buffer_size 128k;
    proxy_buffer_size 16k;
    proxy_buffers 4 32k;
    proxy_busy_buffers_size 64k;

    # ─── Include modular configs ──────────────────────────────────────
    include /etc/nginx/conf.d/upstreams.conf;
    include /etc/nginx/conf.d/rate-limiting.conf;

    # ─── Server block ─────────────────────────────────────────────────
    server {
        listen 8000;
        server_name _;

        # ─── Custom error pages (JSON) ────────────────────────────────
        include /etc/nginx/conf.d/error-pages.conf;

        # ─── CORS (included as snippet) ──────────────────────────────
        include /etc/nginx/conf.d/cors.conf;

        # ─── Handle OPTIONS preflight for all routes ───────────────────
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # ==============================================================
        #  HEALTH CHECK (Gateway itself)
        # ==============================================================
        location = /health {
            access_log off;
            return 200 '{"status":"ok","service":"api-gateway"}';
        }

        # ==============================================================
        #  PUBLIC — only /auth/register, /auth/login, /auth/refresh
        # ==============================================================
        location ~ ^/auth/(register|login|refresh)$ {
            limit_req zone=api_auth burst=10 nodelay;
            proxy_set_header X-User-ID "";
            proxy_set_header X-User-Role "";
            proxy_pass http://user-service$request_uri;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        # ==============================================================
        #  PROTECTED — JWT required; all other routes hidden behind auth
        # ==============================================================
        location = /auth/me {
            limit_req zone=api_general burst=20 nodelay;
            include /etc/nginx/conf.d/protected-snippet.conf;
            proxy_pass http://user-service$request_uri;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        location /auth/ {
            limit_req zone=api_general burst=20 nodelay;
            include /etc/nginx/conf.d/protected-snippet.conf;
            proxy_pass http://user-service$request_uri;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        location /profile/ {
            limit_req zone=api_general burst=20 nodelay;
            include /etc/nginx/conf.d/protected-snippet.conf;
            proxy_pass http://user-service$request_uri;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        location /users/ {
            limit_req zone=api_general burst=20 nodelay;
            include /etc/nginx/conf.d/protected-snippet.conf;
            proxy_pass http://user-service$request_uri;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        # ==============================================================
        #  COURSE SERVICE — All routes protected by JWT
        #  Proxy /courses (no slash) directly to /courses/ so request reaches backend
        # ==============================================================
        location = /courses {
            limit_req zone=api_general burst=20 nodelay;
            include /etc/nginx/conf.d/protected-snippet.conf;
            proxy_pass http://course-service/courses/$is_args$args;
            include /etc/nginx/conf.d/proxy-params.conf;
        }
        location /courses/ {
            limit_req zone=api_general burst=20 nodelay;
            include /etc/nginx/conf.d/protected-snippet.conf;
            proxy_pass http://course-service$request_uri;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        location /course/enrollments {
            limit_req zone=api_general burst=20 nodelay;
            include /etc/nginx/conf.d/protected-snippet.conf;
            proxy_pass http://course-service$request_uri;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        location /course/certificates {
            limit_req zone=api_general burst=20 nodelay;
            include /etc/nginx/conf.d/protected-snippet.conf;
            proxy_pass http://course-service$request_uri;
            include /etc/nginx/conf.d/proxy-params.conf;
        }

        # ==============================================================
        #  INTERNAL — Auth verification subrequest
        # ==============================================================
        location = /internal/auth-verify {
            internal;                       # Only callable by auth_request, not by clients

            proxy_pass http://auth-sidecar/verify;
            proxy_pass_request_body off;                # Don't send the request body
            proxy_set_header Content-Length "";          # Clear content-length
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;

            # Forward the Authorization header to the sidecar
            # (Nginx does this by default, but being explicit)
            proxy_set_header Authorization $http_authorization;
        }

        # Catch-all — return 404
        location / {
            return 404 '{"error":"Not Found","message":"The requested endpoint does not exist"}';
        }
    }
}
